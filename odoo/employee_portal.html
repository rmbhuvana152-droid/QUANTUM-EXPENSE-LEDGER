<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QEL Employee Portal - AI Submission & Anomaly Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a; 
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
            min-height: 100vh;
        }
        .container {
            max-width: 1500px; 
            margin: 0 auto;
            padding: 30px;
        }
        .card {
            background-color: #1e293b; 
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #334155;
        }
        input, select, textarea {
            background-color: #0f172a;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #6366f1; 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
        }
        .header {
            border-bottom: 2px solid #334155;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .status-PENDING { background-color: #f59e0b; color: #1f2937; }
        .status-REJECTED { background-color: #dc2626; color: #fff; }
        .status-SETTLED { background-color: #10b981; color: #fff; }
        .status-PENDING_COMPLIANCE { background-color: #6366f1; color: #fff; }
        .status-PENDING_LIQUIDITY { background-color: #f97316; color: #fff; }
        .risk-HIGH { color: #f87171; font-weight: bold; }
        .risk-LOW { color: #34d399; }
        .risk-MEDIUM { color: #fcd34d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header flex justify-between items-center">
            <h1 class="text-4xl font-extrabold text-indigo-400">QEL Employee Portal - Autonomous Submission</h1>
            <div class="flex items-center space-x-6">
                <div class="text-right">
                    <span class="block text-xl font-semibold" id="userName"></span>
                    <span class="text-sm text-gray-400">DLT ID: <span id="userId"></span></span>
                </div>
                <button onclick="logout()" class="text-sm bg-red-600 hover:bg-red-700 px-5 py-2.5 rounded-lg font-bold transition">Sign Out</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 space-y-8">
                
                <div class="card bg-indigo-900/30">
                    <h2 class="text-2xl font-bold mb-4 border-b border-indigo-600 pb-2 text-indigo-400">OCR Receipt Processing (Feature)</h2>
                    <p class="text-gray-400 mb-4 text-sm">Simulate **OCR data extraction**. (Click twice to inject a HIGH-RISK claim).</p>
                    <button onclick="simulateOCR()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.218A2 2 0 0110.133 4h3.734a2 2 0 011.664.89l.812 1.218A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        SCAN & EXTRACT (TEST)
                    </button>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2 text-purple-400">New DLT Expense Submission</h2>
                    <form id="expenseForm" class="space-y-5">
                        
                        <div id="aiBudget" class="bg-gray-800 p-4 rounded-md text-sm border border-gray-700">
                            <p class="font-bold text-yellow-300 flex justify-between items-center">
                                <span>AI Predictive Max Spend (USD)</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v14c0 1.1-.9 2-2 2H9zm3-8a3 3 0 100-6 3 3 0 000 6z"/></svg>
                            </p>
                            <span id="budgetDisplay" class="text-3xl font-mono text-green-400">$0.00</span>
                            <p id="budgetBasis" class="text-xs text-gray-400 mt-1">Basis: Select Location and Category</p>
                            <input type="hidden" id="maxBudgetUsd">
                        </div>

                        <div>
                            <label for="category" class="block text-sm font-medium mb-1">Category</label>
                            <select id="category" required onchange="fetchPredictiveBudget()">
                                <option value="" disabled selected>Select Category</option>
                                <option value="Meals">Meals</option>
                                <option value="Travel">Travel</option>
                                <option value="Consulting">Client Consulting</option>
                                <option value="Office">Office Supplies</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="location" class="block text-sm font-medium mb-1">Location (For Cost Indexing)</label>
                            <select id="location" required onchange="fetchPredictiveBudget()">
                                <option value="" disabled selected>Select Location</option>
                                <option value="New York">New York</option>
                                <option value="London">London</option>
                                <option value="Paris">Paris</option>
                                <option value="Mysuru">Mysuru</option>
                                <option value="Other">Other (Default Cost)</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="expenseDate" class="block text-sm font-medium mb-1">Expense Date</label>
                                <input type="date" id="expenseDate" required onchange="runPreSubmissionChecks(false)">
                            </div>
                            <div>
                                <label for="expenseTime" class="block text-sm font-medium mb-1">Expense Time (For Anomaly Check)</label>
                                <input type="time" id="expenseTime" required onchange="runPreSubmissionChecks(false)">
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-3">
                            <div class="col-span-2">
                                <label for="amount" class="block text-sm font-medium mb-1">Amount</label>
                                <input type="number" id="amount" placeholder="e.g. 50.00" required min="0.01" step="0.01" oninput="updateUsdConversion(); runPreSubmissionChecks(false);">
                            </div>
                            <div>
                                <label for="currency" class="block text-sm font-medium mb-1">Currency</label>
                                <select id="currency" required onchange="updateUsdConversion(); runPreSubmissionChecks(false);">
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="GBP">GBP</option>
                                </select>
                            </div>
                        </div>

                        <p id="usdConversion" class="text-sm text-gray-400 font-mono">Converted to USD: $0.00 (Current Rate: 1.0000)</p>
                        <input type="hidden" id="amountUsd">
                        
                        <div>
                            <label for="description" class="block text-sm font-medium mb-1">Transaction Context (Mandatory for Compliance)</label>
                            <textarea id="description" rows="3" placeholder="Client dinner on 2025-10-01 for Project Alpha" required maxlength="255"></textarea>
                        </div>
                        
                        <div id="preSubmissionAlert" class="bg-red-900/50 p-4 rounded-md text-sm text-red-300 hidden border border-red-700">
                            <p class="font-bold flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 3c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                <span>RISK ENGINE ALERT: HIGH ANOMALY DETECTED</span>
                            </p>
                            <p id="alertMessage" class="mt-1 font-semibold"></p>
                        </div>

                        <button type="submit" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-150 shadow-lg">
                            SUBMIT TO DLT LEDGER & INITIATE FLOW
                        </button>
                    </form>
                </div>
                
            </div>

            <div class="lg:col-span-8">
                <div class="card h-full">
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2 text-yellow-400">Expense History & Status Tracking (Immutable Ledger)</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead>
                                <tr class="text-left text-xs font-medium text-gray-400 uppercase tracking-wider bg-gray-900/50">
                                    <th class="py-3 px-4">ID</th>
                                    <th class="py-3 px-4">Description</th>
                                    <th class="py-3 px-4">Amount (USD)</th>
                                    <th class="py-3 px-4">AI Risk / LLM Policy</th>
                                    <th class="py-3 px-4">ZKP Proof</th>
                                    <th class="py-3 px-4">Status</th>
                                    <th class="py-3 px-4">Next Step</th>
                                    <th class="py-3 px-4">DLT Hash</th>
                                </tr>
                            </thead>
                            <tbody id="expenseTableBody" class="divide-y divide-gray-800 text-sm">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="scripts.js"></script>
    <script>
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        let ocr_count = 0;

        if (!currentUser || currentUser.role !== 'EMPLOYEE') {
            alert("Access Denied or Session Exired. Please log in as an Employee.");
            window.location.href = 'index.html';
        }

        const employeeId = currentUser.id;
        document.getElementById('userName').textContent = SIMULATED_USERS[employeeId].name;
        document.getElementById('userId').textContent = employeeId;


        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
        
        // FEATURE: OCR Simulation
        function simulateOCR() {
            ocr_count++;
            
            if (ocr_count % 2 !== 0) {
                 // Low Risk Test
                document.getElementById('category').value = 'Meals';
                document.getElementById('location').value = 'New York';
                document.getElementById('amount').value = 95.00;
                document.getElementById('currency').value = 'USD';
                document.getElementById('description').value = 'Client lunch for Project Orion team. 3 people total.';
                document.getElementById('expenseTime').value = '13:00'; 
                alert("OCR Data Injected: A standard, low-risk expense ($95, lunch) has been populated. Submit to proceed to Manager approval.");
            } else {
                 // High Risk Test (For Admin Escalation)
                document.getElementById('category').value = 'Travel';
                document.getElementById('location').value = 'London';
                document.getElementById('amount').value = 5500.00;
                document.getElementById('currency').value = 'GBP';
                document.getElementById('description').value = 'Luxury private jet travel for CEO meeting. Bypassed standard travel policy.';
                document.getElementById('expenseTime').value = '03:45'; 
                alert("OCR Data Injected: A HIGH-RISK expense ($5500 GBP, 'Luxury' keyword, late night) has been populated. Submit to trigger MANDATORY ADMIN ESCALATION and HYBRID FLOW.");
            }
            
            const now = new Date();
            document.getElementById('expenseDate').value = now.toISOString().substring(0, 10);

            updateUsdConversion();
            fetchPredictiveBudget();
            runPreSubmissionChecks(true);
        }

        function updateFxDisplay() {
            // Re-runs the USD conversion to update the display
            updateUsdConversion(); 
        }

        function updateUsdConversion() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const currency = document.getElementById('currency').value;
            const rate = getFxRate(currency);
            
            const amountUsd = (amount * rate).toFixed(2);
            document.getElementById('amountUsd').value = amountUsd;
            
            document.getElementById('usdConversion').textContent = `Converted to USD: $${amountUsd} (Current Rate: 1 ${currency} = ${rate.toFixed(4)} USD)`;
        }

        function fetchPredictiveBudget() {
            const category = document.getElementById('category').value;
            const location = document.getElementById('location').value;

            if (category && location && employeeId) {
                const budget = api_get_predictive_budget(employeeId, location, category);
                document.getElementById('maxBudgetUsd').value = budget.max_spend;
                document.getElementById('budgetDisplay').textContent = `$${budget.max_spend.toLocaleString()}`;
                document.getElementById('budgetBasis').textContent = budget.basis_note;
            } else {
                document.getElementById('budgetDisplay').textContent = `$0.00`;
                document.getElementById('budgetBasis').textContent = 'Basis: Select Location and Category';
            }
        }
        
        // FEATURE 1: Anomaly Check - Easy-to-understand feedback
        function runPreSubmissionChecks(forceShow = false) {
            const amountUsd = parseFloat(document.getElementById('amountUsd').value);
            const category = document.getElementById('category').value;
            const location = document.getElementById('location').value;
            const date = document.getElementById('expenseDate').value;
            const time = document.getElementById('expenseTime').value;
            
            const alertDiv = document.getElementById('preSubmissionAlert');
            
            if (amountUsd && category && location && date && time) {
                const expense_datetime = `${date}T${time}:00`;
                const fraud_data = api_get_fraud_risk_score(employeeId, amountUsd, category, location, expense_datetime);
                
                if (fraud_data.risk_level === "HIGH" || forceShow) {
                    alertDiv.classList.remove('hidden');
                    document.getElementById('alertMessage').textContent = `Fraud Score: ${fraud_data.score}. ${fraud_data.message}. Please provide detailed justification.`;
                } else {
                    alertDiv.classList.add('hidden');
                }
            }
        }


        function renderExpenseHistory() {
            const expenses = DB_API.get_all_expenses().filter(e => e.employee_id === employeeId).sort((a, b) => b.id - a.id);
            const tbody = document.getElementById('expenseTableBody');
            tbody.innerHTML = '';
            
            expenses.forEach(e => {
                const nextStep = e.approval_flow.find(s => s.sequence === e.current_sequence);
                const nextStepName = nextStep ? nextStep.role.split('_')[0] : 'N/A';
                
                const row = `
                    <tr class="hover:bg-gray-800 transition duration-150">
                        <td class="py-3 px-4 font-mono text-gray-400">${e.id}</td>
                        <td class="py-3 px-4 max-w-xs overflow-hidden text-ellipsis whitespace-nowrap" title="${e.description}">${e.description}</td>
                        <td class="py-3 px-4 text-green-400 font-semibold">$${e.amount_usd.toLocaleString()}</td>
                        <td class="py-3 px-4">
                            <span class="risk-${e.fraud_risk_level}">${e.fraud_risk_level} (${e.fraud_risk_score})</span> / 
                            <span class="text-sm font-medium text-blue-300" title="${e.llm_compliance_report.llm_note}">${e.llm_compliance_report.policy_match}</span>
                        </td>
                        <td class="py-3 px-4 text-sm font-mono text-gray-500">${e.zkp_status}</td>
                        <td class="py-3 px-4"><span class="status-badge status-${e.status.split('_')[0]}">${e.status}</span></td>
                        <td class="py-3 px-4 font-semibold text-sm text-yellow-300">${nextStepName}</td>
                        <td class="py-3 px-4 text-xs font-mono" title="${e.dlt_transaction_hash}">${e.dlt_transaction_hash.substring(0, 6)}...</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                employee_id: employeeId,
                amount: parseFloat(document.getElementById('amount').value),
                currency: document.getElementById('currency').value,
                amount_usd: parseFloat(document.getElementById('amountUsd').value),
                category: document.getElementById('category').value,
                location: document.getElementById('location').value,
                description: document.getElementById('description').value,
                date: document.getElementById('expenseDate').value,
                time: document.getElementById('expenseTime').value
            };
            
            if (formData.amount_usd === 0 || isNaN(formData.amount_usd)) {
                 alert("Error: Amount conversion failed. Please check the amount and currency.");
                 return;
            }

            try {
                const result = api_submit_expense(formData);
                alert(`Submission Successful! DLT ID: ${result.id}. Status: ${result.status}. Next Approver: ${result.approval_flow[0].role.split('_')[0]}.`);
                renderExpenseHistory();
                document.getElementById('expenseForm').reset();
                fetchPredictiveBudget(); // Reset budget display
                document.getElementById('preSubmissionAlert').classList.add('hidden');
                updateUsdConversion();
            } catch (error) {
                console.error("Submission Error:", error);
                alert("Error during submission. Check console for details.");
            }
        });

        // Initialize view
        fetchPredictiveBudget();
        renderExpenseHistory();
        updateUsdConversion();
    </script>
</body>
</html>