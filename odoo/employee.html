<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Expense Submission - GlobalTech SEP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f8fafc; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }
        input:focus, select:focus, textarea:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
        }
        .compliance-box {
            transition: background-color 0.3s, border-color 0.3s;
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-6xl mx-auto card p-10 border-t-4 border-indigo-600">
        
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-bold text-indigo-700">SEP Expense Submission Module</h1>
            <p class="text-lg text-gray-500 mt-1">5-Layer AI Pipeline: **RL Nudge, ZKP Compliance, AD Risk, Semantic LLM** updated live.</p>
        </header>

        <form id="expenseForm" class="grid grid-cols-4 gap-8">
            
            <div class="space-y-6 col-span-2">
                <h2 class="text-xl font-semibold mb-3 text-gray-700 border-b pb-2">Financials & Context</h2>
                
                <div>
                    <label for="description" class="block mb-2 text-sm font-medium text-gray-700">Description (Required for Semantic AI)</label>
                    <textarea id="description" rows="3" required placeholder="E.g., Client dinner for the Q3 planning session." 
                              class="p-3 border border-gray-300 rounded-lg w-full" oninput="updateBudgetNudge()">Client dinner with Acme Corp for Q3 launch discussion.</textarea>
                </div>
                
                <div>
                    <label for="category" class="block mb-2 text-sm font-medium text-gray-700">Category</label>
                    <select id="category" required class="p-3 border border-gray-300 rounded-lg w-full bg-white" onchange="updateBudgetNudge()">
                        <option value="Meals">Meals</option>
                        <option value="Travel">Travel</option>
                        <option value="Consulting">Consulting Fees</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="location" class="block mb-2 text-sm font-medium text-gray-700">Location (City)</label>
                        <select id="location" required class="p-3 border border-gray-300 rounded-lg w-full bg-white" onchange="updateBudgetNudge()">
                            <option value="New York">New York</option>
                            <option value="London">London</option>
                            <option value="Mysuru">Mysuru</option>
                            <option value="Paris">Paris</option>
                        </select>
                    </div>

                    <div>
                         <label for="date" class="block mb-2 text-sm font-medium text-gray-700">Date of Expense</label>
                        <input type="date" id="date" value="2025-10-04" required class="p-3 border border-gray-300 rounded-lg w-full bg-white">
                    </div>
                </div>

                 <div>
                    <label for="amountForeign" class="block mb-2 text-sm font-medium text-gray-700">Claimed Amount (Local Currency)</label>
                    <div class="flex rounded-lg shadow-sm">
                        <input type="number" id="amountForeign" step="0.01" value="1200.00" required class="p-3 border border-gray-300 rounded-l-lg w-2/3 focus:ring-0" oninput="updateBudgetNudge()">
                        <select id="currencyForeign" class="p-3 border border-gray-300 rounded-r-lg w-1/3 bg-white focus:ring-0" onchange="updateBudgetNudge()">
                            <option value="EUR">EUR</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>
                
                <div class="p-3 border-l-4 border-yellow-500 bg-yellow-50 rounded-md">
                    <p class="font-medium text-yellow-800 text-sm">Real-Time Conversion Rate: <span id="fxRateDisplay" class="font-mono">--</span></p>
                    <p class="text-xl font-extrabold text-indigo-700 mt-1">Converted: <span id="convertedAmountDisplay">0.00</span> USD</p>
                </div>
                
            </div>

            <div class="space-y-5 col-span-2">
                <h2 class="text-xl font-semibold mb-3 text-gray-700 border-b pb-2">5-Layer AI Pre-Check</h2>

                <div id="budgetNudge" class="compliance-box p-4 rounded-xl border-2 border-indigo-500 bg-indigo-50 shadow-md">
                    <p class="font-bold text-indigo-700">1. RL Agent Limit (Context-Aware)</p>
                    <div id="maxBudget" class="text-xl font-extrabold text-green-600 my-0">--</div>
                </div>
                
                <div id="zkpStatusBox" class="compliance-box p-4 rounded-xl border-2 bg-gray-100 shadow-md">
                    <p class="font-bold text-gray-700 text-lg">2. ZKP Compliance Status</p>
                    <div id="complianceStatus" class="text-lg font-extrabold mt-0">--</div>
                </div>
                
                <div id="adRiskBox" class="compliance-box p-4 rounded-xl border-2 border-gray-300 bg-gray-100 shadow-md">
                    <p class="font-bold text-gray-700 text-lg">3. Anomaly Risk Score</p>
                    <div id="anomalyScore" class="text-lg font-extrabold mt-0">--</div>
                </div>

                <div id="semanticBox" class="compliance-box p-4 rounded-xl border-2 border-gray-300 bg-gray-100 shadow-md">
                    <p class="font-bold text-gray-700 text-lg">4. Semantic Confidence (LLM)</p>
                    <div id="semanticConfidence" class="text-lg font-extrabold mt-0">--</div>
                    <p id="semanticMessage" class="text-xs text-red-500 mt-1"></p>
                </div>
            </div>

            <div class="col-span-4 flex justify-between pt-8 border-t border-gray-200">
                <a href="employee_history.html" class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150">View History</a>
                <button type="submit" class="px-8 py-3 bg-indigo-600 text-white font-extrabold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg">
                    Submit Claim (Activate 5-Layer AI Protocol)
                </button>
            </div>
        </form>
    </div>

    <script src="scripts.js"></script>
    <script>
        const CURRENT_USER = JSON.parse(localStorage.getItem('currentUser')) || { id: 1003, role: "EMPLOYEE" };
        const EMPLOYEE_ID = CURRENT_USER.id;

        function updateFxRateDisplay() {
             const currency = document.getElementById('currencyForeign').value;
             let rateText = '1.00000';
             if (currency === 'EUR') rateText = `1 EUR = ${getFxRate('EUR').toFixed(5)} USD`;
             if (currency === 'GBP') rateText = `1 GBP = ${getFxRate('GBP').toFixed(5)} USD`;
             if (currency === 'USD') rateText = `1 USD = 1.00000 USD`;
             document.getElementById('fxRateDisplay').textContent = rateText;
        }

        function updateBudgetNudge() {
            const amount = parseFloat(document.getElementById('amountForeign').value) || 0;
            const currency = document.getElementById('currencyForeign').value;
            const category = document.getElementById('category').value;
            const location = document.getElementById('location').value;
            const description = document.getElementById('description').value;

            // --- Conversion and RL Agent ---
            const rate = parseFloat(getFxRate(currency));
            const amount_usd = (rate > 0) ? parseFloat((amount * rate).toFixed(2)) : 0;
            document.getElementById('convertedAmountDisplay').textContent = amount_usd.toFixed(2);
            updateFxRateDisplay(); // Update real-time FX display

            const { max_spend } = api_get_dynamic_budget(location, category);
            document.getElementById('maxBudget').textContent = `$${max_spend} USD`;
            const isCompliant = amount_usd <= max_spend;

            // --- ZKP Status Update ---
            const zkpBox = document.getElementById('zkpStatusBox');
            const complianceEl = document.getElementById('complianceStatus');
            zkpBox.className = 'compliance-box p-4 rounded-xl border-2 shadow-md';
            if (isCompliant) {
                zkpBox.classList.add('border-green-500', 'bg-green-50');
                complianceEl.innerHTML = `**COMPLIANT** (Under Limit)`;
            } else {
                zkpBox.classList.add('border-red-500', 'bg-red-50');
                complianceEl.innerHTML = `**NON-COMPLIANT** (Policy Breach)`;
            }
            
            // --- AD Engine Status Update ---
            const fraudData = api_get_fraud_risk_score(EMPLOYEE_ID, amount_usd, category, location);
            const adRiskBox = document.getElementById('adRiskBox');
            const anomalyScoreEl = document.getElementById('anomalyScore');
            adRiskBox.className = 'compliance-box p-4 rounded-xl border-2 shadow-md';

            if (fraudData.risk_level === 'LOW') {
                adRiskBox.classList.add('border-green-500', 'bg-green-50');
            } else if (fraudData.risk_level === 'MEDIUM') {
                adRiskBox.classList.add('border-yellow-500', 'bg-yellow-50');
            } else { 
                adRiskBox.classList.add('border-red-500', 'bg-red-50');
            }
            anomalyScoreEl.innerHTML = `${fraudData.score} / 99 (${fraudData.risk_level})`;


            // --- NEW: Semantic LLM Confidence Update ---
            const semanticData = api_get_llm_semantic_confidence(category, description);
            const semanticBox = document.getElementById('semanticBox');
            const semanticConfidenceEl = document.getElementById('semanticConfidence');
            const semanticMessageEl = document.getElementById('semanticMessage');
            semanticBox.className = 'compliance-box p-4 rounded-xl border-2 shadow-md';

            if (semanticData.confidence_level === 'LOW') {
                semanticBox.classList.add('border-red-500', 'bg-red-50');
                semanticMessageEl.textContent = 'Action: Policy flow escalated due to vague description. Please be more specific!';
            } else if (semanticData.confidence_level === 'MEDIUM') {
                semanticBox.classList.add('border-yellow-500', 'bg-yellow-50');
                semanticMessageEl.textContent = 'Nudge: Improve clarity for faster approval.';
            } else {
                semanticBox.classList.add('border-green-500', 'bg-green-50');
                semanticMessageEl.textContent = 'Status: Context is clear and accurate.';
            }
             semanticConfidenceEl.innerHTML = `${semanticData.score} / 100 (${semanticData.confidence_level})`;
        }

        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const amountForeign = parseFloat(document.getElementById('amountForeign').value);
            const currencyForeign = document.getElementById('currencyForeign').value;
            const category = document.getElementById('category').value;
            const location = document.getElementById('location').value;
            const description = document.getElementById('description').value;
            
            const amount_usd = parseFloat((amountForeign * getFxRate(currencyForeign)).toFixed(2));
            const { max_spend } = api_get_dynamic_budget(location, category);
            
            // 1. Generate ZKP Proof
            const zkp_proof = api_generate_zkp_proof(amount_usd, max_spend);
            
            const expenseData = {
                employee_id: EMPLOYEE_ID,
                amount_foreign: amountForeign,
                currency_foreign: currencyForeign,
                amount_usd: amount_usd,
                category: category,
                location: location,
                date: document.getElementById('date').value,
                description: description,
                zkp_proof: zkp_proof
            };

            // 2. Submit to DLT (Triggers all remaining AI layers for final record)
            const result = api_submit_expense(expenseData);
            
            alert(`Claim Submitted! (ID: ${result.id})\n\n-- AI SUMMARY --\nZKP Status: ${result.zkp_status}\nFraud Risk: ${result.fraud_risk_level} (${result.fraud_risk_score})\nSemantic Conf: ${result.semantic_confidence_level} (${result.semantic_confidence_score})\n\nInitial Status: ${result.status} (Forwarded to ${result.approval_flow[0].role})`);
            
            document.getElementById('expenseForm').reset();
            window.location.href = 'employee_history.html'; 
        });

        // Initialize display and start the FX rate real-time update loop
        updateBudgetNudge(); 
        setInterval(updateBudgetNudge, 10000); 
    </script>
</body>
</html>